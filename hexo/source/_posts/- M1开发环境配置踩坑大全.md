---
title: M1 开发环境配置踩坑记录
categories: [devissue]
tags: [devissue]
---



## M1 开发环境配置踩坑大全

### 使用 m1 GPU 训练 Tensorflow

Please try the same after creating a virtual environment.

```shell
python3 -m venv ~/tensorflow-metal
source ~/tensorflow-metal/bin/activate
python -m pip install -U pip
python -m pip install tensorflow-macos
python -m pip install tensorflow-metal
```



使用 `bench.py` 测试 m1 性能，运行时间为 108.47s（作为对比，24 核 gpu m1max 运行时间为 58s)

```python
import tensorflow as tf
import tensorflow_datasets as tfds
import time


print("TensorFlow version:", tf.__version__)
print("Num GPUs Available: ", len(tf.config.experimental.list_physical_devices('GPU')))
start_time = time.time()
# tf.config.list_physical_devices('GPU')

(ds_train, ds_test), ds_info = tfds.load(
    'mnist',
    split=['train', 'test'],
    shuffle_files=True,
    as_supervised=True,
    with_info=True,
)

def normalize_img(image, label):
  """Normalizes images: `uint8` -> `float32`."""
  return tf.cast(image, tf.float32) / 255., label

batch_size = 128
ds_train = ds_train.map(
    normalize_img, num_parallel_calls=tf.data.experimental.AUTOTUNE)
ds_train = ds_train.cache()
ds_train = ds_train.shuffle(ds_info.splits['train'].num_examples)
ds_train = ds_train.batch(batch_size)
ds_train = ds_train.prefetch(tf.data.experimental.AUTOTUNE)
ds_test = ds_test.map(
    normalize_img, num_parallel_calls=tf.data.experimental.AUTOTUNE)
ds_test = ds_test.batch(batch_size)
ds_test = ds_test.cache()
ds_test = ds_test.prefetch(tf.data.experimental.AUTOTUNE)

model = tf.keras.models.Sequential([
  tf.keras.layers.Conv2D(32, kernel_size=(3, 3),
                 activation='relu'),
  tf.keras.layers.Conv2D(64, kernel_size=(3, 3),
                 activation='relu'),
  tf.keras.layers.MaxPooling2D(pool_size=(2, 2)),
#   tf.keras.layers.Dropout(0.25),
  tf.keras.layers.Flatten(),
  tf.keras.layers.Dense(128, activation='relu'),
#   tf.keras.layers.Dropout(0.5),
  tf.keras.layers.Dense(10, activation='softmax')
])

model.compile(
    loss='sparse_categorical_crossentropy',
    optimizer=tf.keras.optimizers.Adam(0.001),
    metrics=['accuracy'],
)

model.fit(
    ds_train,
    epochs=12,
    validation_data=ds_test,
)

end_time = time.time()
print("Time consumed: {:.2f}秒".format(end_time - start_time))
```



### 运行 TensorFlow 报错

```shell
ERROR: Could not find a version that satisfies the requirement tensorflow (from versions: none)
ERROR: No matching distribution found for tensorflow
```

原因：Python的版本过高。使用指令：python --version 查看当前使用的Python版本。TensorFlow支持的Python版本只到python3.5。

解决方案：

1. 把当前的Python卸载掉，安装python3.5
2. 指定安装支持高版本Python的TensorFlow

```shell
python3 -m pip install --upgrade https://storage.googleapis.com/tensorflow/mac/cpu/tensorflow-0.12.0-py3-none-any.whl
```



### M1 安装 pytorch

```shell
# torch create virtual environment
conda create -n torch_nightly_env python=3.8
conda activate torch_nightly_env
conda install PyTorch torchvision -c pytorch-nightly
```



### m1 安装 qemu 卡死问题

按照官网步骤使用 brew 安装 qemu 之后，`make install` 会卡死在第一步，在这一 issue 中找到了解决方案:

https://github.com/BASARANOMO/xv6-labs-2020/issues/1

Then, download the qemu-5.1.0 and unzip the downloaded `.tar.xz` file:

```shell
$ wget https://download.qemu.org/qemu-5.1.0.tar.xz
```

Two patches are needed:
[patch1](https://patchwork.kernel.org/project/qemu-devel/patch/20210103145055.11074-1-r.bolshakov@yadro.com/): just download it and `cd` to the qemu directory, then:

```shell
$ patch -p1 < ../patch/v2-tcg-Fix-execution-on-Apple-Silicon.patch
```

[patch2](https://gist.github.com/stefannilsson/8a083e07f4103af2520e87fdb1f50efc/revisions): Two lines only. Find the file in qemu directory and modify it.
Then run configure with:

```shell
$ ./configure --disable-kvm --disable-werror --prefix=/usr/local --target-list="riscv64-softmmu"
```

```shell
$ make
$ make install
```



### Catalina quarantine for corrupted apps

低于 `Big Sur` 系统版本的 `macOS` 或 `m1` 芯片机器在安装一些未适配软件时候可能会出现 `安装包损坏, 打不开“XXX”,因为它来自身份不明的开发者` 等报错，在此状态下可以尝试以下做法。

```shell
sudo spctl --master-disable
sudo xattr -r -d com.apple.quarantine /Applications/Sketch.app/
// 输入 sudo xattr -r -d com.apple.quarantine 后将应用程序拖入 teminal 中
```

（以及 Catalina 真的好耐看啊！）



### 删除 .DS_Store

删除当前目录及其子目录下的所有.DS_Store 文件:

```shell
find . -name '*.DS_Store' -type f -delete
```

禁止.DS_store生成：

```shell
defaults write com.apple.desktopservices DSDontWriteNetworkStores -bool TRUE
```

恢复.DS_store生成：

```shell
defaults delete com.apple.desktopservices DSDontWriteNetworkStores
```

将 .DS_Store 加入到 .gitignore

```sh
echo .DS_Store >> ~/.gitignore
```



## Dev-Util

### Google Maps API

|      | 网址                                                         | 功能说明                                                 |
| ---- | ------------------------------------------------------------ | -------------------------------------------------------- |
| 1    | https://snazzymaps.com/                                      | 带有 JSON 代码和可下载示例的 Google 地图配色方案的存储库 |
| 2    | https://googlemapsmania.blogspot.com/search/label/Styled%20Maps |                                                          |
| 3    | https://mapstyle.withgoogle.com/                             |                                                          |

